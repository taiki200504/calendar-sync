# OAuth エラー 403: access_denied の解決方法

## 🔴 エラーの原因

```
エラー 403: access_denied
calendar to schedule は Google の審査プロセスを完了していません。
このアプリは現在テスト中で、デベロッパーに承認されたテスターのみがアクセスできます。
```

このエラーは、**OAuth同意画面がテストモード**になっていて、使用しているGoogleアカウントが**テストユーザーに追加されていない**ために発生します。

---

## ✅ 解決方法

### 方法1: テストユーザーを追加（推奨・開発中）

開発中は、テストユーザーを追加するのが最も簡単です。

#### 手順

1. **Google Cloud Consoleにアクセス**
   - https://console.cloud.google.com/

2. **プロジェクトを選択**
   - 使用しているプロジェクトを選択

3. **OAuth同意画面を開く**
   - 左メニューから「**APIとサービス**」→「**OAuth同意画面**」をクリック

4. **テストユーザーを追加**
   - 「**テストユーザー**」セクションを探す
   - 「**ユーザーを追加**」ボタンをクリック
   - **使用するGoogleアカウントのメールアドレス**を入力
   - 「**追加**」をクリック

5. **保存**
   - 変更を保存

6. **再度ログインを試す**
   - ブラウザで `http://localhost:5173` にアクセス
   - 「Googleでログイン」をクリック
   - 今度は正常に認証できるはずです

#### 複数のユーザーを追加する場合

複数のGoogleアカウントでテストする場合は、それぞれのメールアドレスを追加してください。

---

### 方法2: OAuth同意画面を本番モードに公開（本番環境用）

本番環境で使用する場合は、OAuth同意画面を公開する必要があります（Googleの審査が必要な場合があります）。

#### 手順

1. **OAuth同意画面を開く**
   - Google Cloud Console → 「APIとサービス」→ 「OAuth同意画面」

2. **公開状態を確認**
   - 現在「**テスト中**」になっていることを確認

3. **公開を申請**
   - 「**公開**」ボタンをクリック
   - 確認ダイアログで「**公開**」をクリック

4. **注意事項**
   - 公開すると、すべてのGoogleユーザーがアプリを使用できるようになります
   - スコープによっては、Googleの審査が必要な場合があります
   - 審査には数日かかる場合があります

---

## 🔍 現在の設定を確認する方法

### Google Cloud Consoleで確認

1. https://console.cloud.google.com/ にアクセス
2. プロジェクトを選択
3. 「**APIとサービス**」→「**OAuth同意画面**」を開く
4. 「**テストユーザー**」セクションを確認
   - 追加されているユーザーのリストが表示されます
   - 使用しているGoogleアカウントが含まれているか確認

---

## ⚠️ よくある問題

### 問題1: テストユーザーを追加したのにエラーが続く

**原因**: 
- ブラウザのキャッシュ
- セッションが残っている

**解決方法**:
1. ブラウザのキャッシュをクリア
2. シークレット/プライベートモードで再度試す
3. 別のブラウザで試す

### 問題2: テストユーザーのリストに表示されない

**原因**: 
- メールアドレスの入力ミス
- 保存されていない

**解決方法**:
1. メールアドレスが正確に入力されているか確認
2. 「保存」ボタンをクリックしたか確認
3. ページをリロードして再度確認

### 問題3: 複数のGoogleアカウントでテストしたい

**解決方法**:
- 各Googleアカウントのメールアドレスをテストユーザーに追加
- または、OAuth同意画面を公開する

---

## 📋 チェックリスト

- [ ] Google Cloud Consoleにアクセス
- [ ] 正しいプロジェクトを選択
- [ ] OAuth同意画面を開く
- [ ] テストユーザーセクションを確認
- [ ] 使用するGoogleアカウントのメールアドレスを追加
- [ ] 変更を保存
- [ ] ブラウザのキャッシュをクリア（必要に応じて）
- [ ] 再度ログインを試す

---

## 🎯 クイックリファレンス

### テストユーザーを追加する最短手順

1. https://console.cloud.google.com/ → プロジェクト選択
2. 「APIとサービス」→「OAuth同意画面」
3. 「テストユーザー」→「ユーザーを追加」
4. メールアドレスを入力 → 「追加」
5. 保存
6. 再度ログインを試す

---

## 📚 関連ドキュメント

- `OAUTH_SETUP_GUIDE.md` - OAuth設定の詳細ガイド
- `QUICK_OAUTH_SETUP.md` - OAuth設定のクイックガイド

---

## 💡 開発中の推奨設定

開発中は、以下の設定を推奨します：

1. **OAuth同意画面**: テストモードのまま
2. **テストユーザー**: 開発に使用するGoogleアカウントを追加
3. **スコープ**: 必要最小限のスコープのみ

これにより、セキュリティを保ちながら開発を進められます。

---

## ✅ 解決確認

テストユーザーを追加した後、以下で確認：

1. ブラウザで `http://localhost:5173` にアクセス
2. 「Googleでログイン」をクリック
3. Googleアカウントで認証
4. エラーが表示されず、ダッシュボードが表示されれば成功！

---

上記の手順で問題が解決しない場合は、以下を確認してください：

- Google Cloud Consoleで正しいプロジェクトを選択しているか
- OAuth 2.0 クライアントIDが正しく設定されているか
- `.env`ファイルの`GOOGLE_CLIENT_ID`が正しいか
