# カレンダーが表示されない・同期がうまくいかないとき

## いまの状態の整理

| 現象 | 想定される原因 |
|------|----------------|
| カレンダー一覧が空（0件） | ① Google のトークンが DB にない ② カレンダー取得がまだ一度も成功していない |
| 「今すぐ同期」しても変化がない | ① 同期ON のカレンダーが 0 件 ② 上記のためカレンダー自体が登録されていない |
| アカウントは表示されるが「未同期」のまま | そのアカウントに Google Calendar 用のトークンが保存されていない |

---

## なぜこうなるか（流れの整理）

1. **ログイン方法が 2 種類ある**
   - **A. 「Googleでログイン」（Supabase）**  
     ログイン画面の「Googleでログイン」→ Supabase 経由で Google 認証  
     → **メールと Supabase 用の情報だけ**が使われ、**Google Calendar API 用のトークンは DB に保存されない**。
   - **B. 「+ アカウントを追加」（バックエンド OAuth）**  
     ダッシュボードの「+ アカウントを追加」→ `/api/auth/google` → Google の「カレンダーへのアクセス」許可  
     → **アクセス／リフレッシュトークンが DB に保存される**。このあとカレンダー一覧の取得・同期が可能になる。

2. **カレンダー表示・同期に必要なもの**
   - DB の `accounts` に、そのアカウント用の **`oauth_access_token` / `oauth_refresh_token`** が入っていること。
   - 上記は **B の「アカウントを追加」** のときだけ保存される。
   - A だけでログインした場合は、**カレンダー用トークンが入らない**ため、カレンダー取得も同期も動かない。

3. **実際の処理の流れ**
   - カレンダー一覧 → バックエンドが **Google Calendar API** で取得 → DB の `calendars` に保存 → 画面に表示。
   - 同期 → 同じく Google のトークンを使って API を叩き、イベントを取得・反映。
   - トークンが無い → API が使えない → カレンダーも同期もできない。

---

## 対処手順（まとめ）

### ステップ 1: Google カレンダーを連携する（削除不要）

1. ダッシュボード上部に **「カレンダーを表示するには」** の案内が出ている場合、その中の **「Googleカレンダーを連携」** ボタンを押す。
2. または **「アカウント一覧」** の **「+ アカウントを追加」** を押す。
3. 表示された Google の画面で、**いまログインしているのと同じ Google アカウント**でログインする。
4. **「カレンダーへのアクセスを許可」** を必ず許可する。
5. リダイレクトでダッシュボードに戻る。

※ 同じメールのアカウントは **更新** されるため、いったん削除する必要はありません。

このときバックエンドで以下が行われます。

- Google の **アクセス／リフレッシュトークン** が DB に保存される（既存アカウントの場合は上書き）。
- 続けて **カレンダー一覧の自動取得** が実行され、`calendars` に登録される。
- ダッシュボードを開くと **自動で同期** も 1 回走る。

---

### ステップ 2: 表示と同期の確認

1. **「カレンダー一覧」** に、そのアカウントのカレンダーが表示されるか確認する。
2. 表示されていれば、各カレンダーの **同期 ON/OFF** を好みに設定する。
3. **「同期接続」** で、相互同期したい 2 つのカレンダーを選んで「接続する」。
4. **「今すぐ同期」** で手動でも同期できることを確認する。

---

## よくあるパターンと対処

| 状況 | 対処 |
|------|------|
| 最初に「Googleでログイン」だけした | ダッシュボードの「Googleカレンダーを連携」ボタンか「+ アカウントを追加」から、同じ Google アカウントで連携する（削除不要）。 |
| 「カレンダーを再取得」を押しても 401 / 500 が出る | トークンが無いか、**ENCRYPTION_KEY 不一致**（別環境で連携したなど）。→ アカウント削除のうえ、再度「+ アカウントを追加」で連携し直す。 |
| カレンダーは出るが同期されない | 「同期接続」で、同期したい 2 つのカレンダーを「接続する」しているか確認。接続していないと相互同期は動かない。 |
| 追加直後にカレンダーが 0 件のまま | 自動取得が失敗している可能性。**「カレンダーを再取得」** を 1 回押して再実行してみる。 |

---

## チェックリスト（カレンダー表示・同期まで）

- [ ] **「Googleカレンダーを連携」** または **「+ アカウントを追加」** から、同じ Google アカウントで連携した
- [ ] Google の許可画面で **「カレンダーへのアクセス」** を許可した
- [ ] ダッシュボードの **「カレンダー一覧」** にカレンダーが表示されている
- [ ] 同期したいカレンダーは **同期 ON** になっている
- [ ] 相互同期したい 2 つのカレンダーは **「同期接続」** で「接続する」済み
- [ ] 必要に応じて **「今すぐ同期」** を押して同期できている

---

## 技術メモ（開発者向け）

- カレンダー取得: `POST /api/calendars/:accountId/sync`（Google Calendar API で一覧取得 → DB の `calendars` に保存）。
- 同期実行: `POST /api/sync/trigger`（同期ON のカレンダーについて `syncService.syncCalendar` を実行）。
- トークンは `accounts.oauth_access_token` / `oauth_refresh_token`（ENCRYPTION_KEY で暗号化）。Supabase ログインだけではここは null のまま。
- 「アカウントを追加」＝ `/api/auth/google` の OAuth フローで、ここで初めて Google のトークンが DB に保存される。
