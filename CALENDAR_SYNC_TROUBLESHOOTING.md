# カレンダーが表示されない・同期がうまくいかないとき

## 通常の流れ（1回認証で完了）

**「Googleでログイン」を1回押すと、以下が自動で行われます。**

1. Google でログイン・カレンダーへのアクセス許可
2. トークン保存 → カレンダー一覧の取得 → ダッシュボードへリダイレクト
3. ダッシュボードでカレンダー表示・自動で1回同期

追加の「連携」や「アカウントを追加」は不要です。

---

## うまくいかないときの整理

| 現象 | 想定される原因 |
|------|----------------|
| カレンダー一覧が空（0件） | ① 初回ログイン時にカレンダー取得が失敗した ② ENCRYPTION_KEY 不一致でトークン復号失敗 |
| 「今すぐ同期」しても変化がない | ① 同期ON のカレンダーが 0 件 ② 同期接続でペアを設定していない |

---

## 対処手順（カレンダーが空のときだけ）

通常は **「Googleでログイン」1回** でカレンダーまで表示されます。表示されない場合のみ、以下を試してください。

1. ダッシュボードの **「Googleカレンダーを連携」** ボタン、または **「+ アカウントを追加」** を押す。
2. **同じ Google アカウント**でログインし、**「カレンダーへのアクセスを許可」** を許可する。
3. 戻ったあと、カレンダー一覧に表示されるか確認する。まだ空なら **「カレンダーを再取得」** を押す。

---

### 表示と同期の確認

1. **「カレンダー一覧」** に、そのアカウントのカレンダーが表示されるか確認する。
2. 表示されていれば、各カレンダーの **同期 ON/OFF** を好みに設定する。
3. **「同期接続」** で、相互同期したい 2 つのカレンダーを選んで「接続する」。
4. **「今すぐ同期」** で手動でも同期できることを確認する。

---

## よくあるパターンと対処

| 状況 | 対処 |
|------|------|
| ログイン直後にカレンダーが 0 件 | **「Googleカレンダーを連携」** または **「カレンダーを再取得」** を 1 回押す。 |
| 「カレンダーを再取得」で 401 / 500 | **ENCRYPTION_KEY 不一致**の可能性。アカウントを削除し、「+ アカウントを追加」で同じアカウントを再度連携する。 |
| カレンダーは出るが同期されない | 「同期接続」で、同期したい 2 つのカレンダーを「接続する」しているか確認する。 |

---

## チェックリスト（うまくいかないとき）

- [ ] ログイン時に Google で **「カレンダーへのアクセス」** を許可した
- [ ] ダッシュボードの **「カレンダー一覧」** にカレンダーが表示されている
- [ ] 同期したいカレンダーは **同期 ON**、相互同期するペアは **「同期接続」** で接続済み
- [ ] 必要に応じて **「今すぐ同期」** または **「カレンダーを再取得」** を試した

---

## 技術メモ（開発者向け）

- ログイン＝ `/api/auth/google` の OAuth 1 回で、トークン保存・カレンダー取得・リダイレクトまで実施。
- カレンダー取得: コールバック内で `calendarService.fetchCalendars(account.id)` を await。
- 同期: `POST /api/sync/trigger` で同期ON カレンダーを即時同期。ダッシュボード表示時に自動で 1 回実行。
